<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        /* Custom styles for the slider ticks */
        .tick-container span {
            position: relative;
            text-align: center;
            width: 14.28%; 
        }
        .tick-container span::before {
            content: '|';
            display: block;
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 8px; /* Smaller tick mark */
        }
        </style>
        <title></title>
    </head>
    <body>
        
        <div id="slider-container" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); text-align: center; font-family: sans-serif; width: 60%; max-width: 450px;">
            
            <div style="margin-bottom: 5px; font-size: 12px; color: #333;">
                Historical Imagery: <strong><span id="yearLabel" style="color: #0078A8; font-size: 14px;">2025</span></strong>
            </div>

            <input type="range" id="yearRange" min="0" max="6" value="6" step="1" style="width: 100%; cursor: pointer; margin: 0;">
            
            <div class="tick-container" style="display: flex; justify-content: space-between; margin-top: 2px; color: #666; font-size: 9px;">
                <span style="text-align: left;">2007</span>
                <span>2008</span>
                <span>2010</span>
                <span>2013</span>
                <span>2017</span>
                <span>2021</span>
                <span style="text-align: right;">2025</span>
            </div>
        </div>

        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.wms.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/NeighborhoodClusters_7.js"></script>
        <script src="data/Overview_9.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:20, minZoom:1
        }).fitBounds([[38.61363104788579,-77.17989526517282],[38.8921128839539,-76.91902964505816]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        
        // ... (Popup functions omitted for brevity, they remain unchanged) ...
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        // ... (End Popup functions) ...

        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            map.setMaxBounds(map.getBounds());
            map.setMinZoom(map.getZoom());
        }

        // WMS LAYERS (Unchanged)
        map.createPane('pane_2025_0');
        map.getPane('pane_2025_0').style.zIndex = 400;
        var layer_2025_0 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2025_WebMercator/MapServer/WMSServer", "0", {
            pane: 'pane_2025_0', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2025_0);

        map.createPane('pane_2021_1');
        map.getPane('pane_2021_1').style.zIndex = 401;
        var layer_2021_1 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2021_WebMercator/MapServer/WMSServer", "0", {
            pane: 'pane_2021_1', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2021_1);

        map.createPane('pane_2017_2');
        map.getPane('pane_2017_2').style.zIndex = 402;
        var layer_2017_2 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2017_WebMercator/MapServer/WMSServer", "0", {
            pane: 'pane_2017_2', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2017_2);

        map.createPane('pane_2013_3');
        map.getPane('pane_2013_3').style.zIndex = 403;
        var layer_2013_3 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2013_WebMercator/MapServer/WMSServer", "0", {
            pane: 'pane_2013_3', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2013_3);

        map.createPane('pane_2010_4');
        map.getPane('pane_2010_4').style.zIndex = 404;
        var layer_2010_4 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2010_WebMercator/MapServer/WMSServer", "0", {
            pane: 'pane_2010_4', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2010_4);

        map.createPane('pane_2008_5');
        map.getPane('pane_2008_5').style.zIndex = 405;
        var layer_2008_5 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/08Ortho/MapServer/WMSServer", "0", {
            pane: 'pane_2008_5', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2008_5);

        map.createPane('pane_2007_6');
        map.getPane('pane_2007_6').style.zIndex = 406;
        var layer_2007_6 = L.WMS.layer("https://maps2.dcgis.dc.gov/dcgis/services/07Ortho/MapServer/WMSServer", "0", {
            pane: 'pane_2007_6', format: 'image/png', uppercase: true, transparent: true, continuousWorld : true, tiled: true, info_format: 'text/html', opacity: 1, identify: false, attribution: '',
        });
        map.addLayer(layer_2007_6);

        // Neighborhoods (Unchanged)
        function pop_NeighborhoodClusters_7(feature, layer) {
            var popupContent = '<table><tr><td colspan="2">' + (feature.properties['NBH_NAMES'] !== null ? autolinker.link(String(feature.properties['NBH_NAMES']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
            layer.bindPopup(content, { maxHeight: 400 });
        }
        function style_NeighborhoodClusters_7_0() {
            return { pane: 'pane_NeighborhoodClusters_7', opacity: 1, color: 'rgba(53,121,177,1.0)', dashArray: '8.0,4.0', lineCap: 'square', lineJoin: 'bevel', weight: 2.0, fillOpacity: 0, interactive: false, }
        }
        map.createPane('pane_NeighborhoodClusters_7');
        map.getPane('pane_NeighborhoodClusters_7').style.zIndex = 407;
        map.getPane('pane_NeighborhoodClusters_7').style['mix-blend-mode'] = 'normal';
        var layer_NeighborhoodClusters_7 = new L.geoJson(json_NeighborhoodClusters_7, {
            attribution: '', interactive: false, dataVar: 'json_NeighborhoodClusters_7', layerName: 'layer_NeighborhoodClusters_7', pane: 'pane_NeighborhoodClusters_7', onEachFeature: pop_NeighborhoodClusters_7, style: style_NeighborhoodClusters_7_0,
        });
        bounds_group.addLayer(layer_NeighborhoodClusters_7);
        map.addLayer(layer_NeighborhoodClusters_7);

        // -----------------------------------------------------------
        // LABELS: UPDATED FOR SMALLER SIZE AND LESS BLUR
        // -----------------------------------------------------------
        map.createPane('pane_LabelsWhiteText_8');
        map.getPane('pane_LabelsWhiteText_8').style.zIndex = 408;
        
        var layer_LabelsWhiteText_8 = L.tileLayer('https://a.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}@2x.png', {
            pane: 'pane_LabelsWhiteText_8',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 20,
            minNativeZoom: 0,
            maxNativeZoom: 18,
            
            // HACK TO REDUCE TEXT SIZE:
            // We tell Leaflet the tiles are 512px (Retina) but load standard tiles, 
            // effectively scaling the text down by 50%.
            tileSize: 512, 
            zoomOffset: -1 
        });
        map.addLayer(layer_LabelsWhiteText_8);
        
        // CSS FILTER UPDATE: 
        // Reduced brightness/contrast to fix "wide border" blur.
        var labelPane = map.getPane('pane_LabelsWhiteText_8');
        if (labelPane) {
            labelPane.style.filter = 'invert(100%) brightness(130%) contrast(130%) grayscale(100%)';
        }

        // Overview (Unchanged)
        function pop_Overview_9(feature, layer) {
            var popupContent = '<table><tr><td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
            layer.bindPopup(content, { maxHeight: 400 });
        }
        function style_Overview_9_0() {
            return { pane: 'pane_Overview_9', opacity: 1, color: 'rgba(247,247,247,1.0)', dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(82,82,82,1.0)', interactive: false, }
        }
        map.createPane('pane_Overview_9');
        map.getPane('pane_Overview_9').style.zIndex = 409;
        map.getPane('pane_Overview_9').style['mix-blend-mode'] = 'normal';
        var layer_Overview_9 = new L.geoJson(json_Overview_9, {
            attribution: '', interactive: false, dataVar: 'json_Overview_9', layerName: 'layer_Overview_9', pane: 'pane_Overview_9', onEachFeature: pop_Overview_9, style: style_Overview_9_0,
        });
        bounds_group.addLayer(layer_Overview_9);
        map.addLayer(layer_Overview_9);
        
        // Layer Control
        var overlaysTree = [
            {label: '<img src="legend/Overview_9.png" /> Overview', layer: layer_Overview_9},
            {label: "Labels - White Text", layer: layer_LabelsWhiteText_8},
            {label: '<img src="legend/NeighborhoodClusters_7.png" /> Neighborhood Clusters', layer: layer_NeighborhoodClusters_7},
        ];
        var lay = L.control.layers.tree(null, overlaysTree,{ collapsed: true });
        lay.addTo(map);
        setBounds();

        // SLIDER LOGIC
        var timeLayers = [layer_2007_6, layer_2008_5, layer_2010_4, layer_2013_3, layer_2017_2, layer_2021_1, layer_2025_0];
        var years = ["2007", "2008", "2010", "2013", "2017", "2021", "2025"];
        var slider = document.getElementById("yearRange");
        var label = document.getElementById("yearLabel");

        slider.oninput = function() {
            var index = this.value; 
            label.innerHTML = years[index]; 
            timeLayers.forEach(function(lyr) { map.removeLayer(lyr); });
            map.addLayer(timeLayers[index]);
            if(map.hasLayer(layer_LabelsWhiteText_8)) { layer_LabelsWhiteText_8.bringToFront(); }
            if(map.hasLayer(layer_Overview_9)) { layer_Overview_9.bringToFront(); }
            if(map.hasLayer(layer_NeighborhoodClusters_7)) { layer_NeighborhoodClusters_7.bringToFront(); }
        }
        slider.oninput();
        </script>        
    </body>
</html>

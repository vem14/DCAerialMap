<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">

        <style>
            /* --- BASE MAP STYLE --- */
            html, body, #map {
                width: 100%; height: 100%; padding: 0; margin: 0;
                background: #202020; /* Dark Background */
            }

            /* --- UI CONTAINER (The Grey Box) --- */
            #slider-container {
                position: absolute; top: 10px; left: 50%; 
                transform: translateX(-50%); z-index: 1000;
                background: rgba(220, 220, 220, 0.95); /* Grey Theme */
                backdrop-filter: blur(3px);
                padding: 8px 12px; border-radius: 4px;
                border: 1px solid #999;
                box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                text-align: center; font-family: sans-serif;
                width: 50%; max-width: 450px;
            }

            /* --- SLIDER TICKS (Aligned) --- */
            .tick-container {
                display: flex; justify-content: space-between;
                margin: 2px 7px 0 7px; /* 7px alignment fix */
                color: #333; font-size: 8px;
            }
            .tick-container span {
                position: relative; display: flex; justify-content: center;
                text-align: center; width: 0; white-space: nowrap; padding-top: 4px;
            }
            .tick-container span::before {
                content: '|'; position: absolute; top: -10px;
                font-weight: normal; font-size: 8px; color: #666;
            }

            /* --- SLIDER INPUT STYLING --- */
            input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; margin: 0; }
            input[type=range]:focus { outline: none; }
            
            /* Thumb (Handle) */
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none; height: 14px; width: 14px;
                border-radius: 50%; background: #0078A8; /* Brand Blue */
                cursor: pointer; margin-top: -5px; border: 1px solid #fff;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
            input[type=range]::-moz-range-thumb {
                height: 14px; width: 14px; border-radius: 50%;
                background: #0078A8; cursor: pointer; border: 1px solid #fff;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }

            /* Track (Line) */
            input[type=range]::-webkit-slider-runnable-track {
                width: 100%; height: 4px; cursor: pointer;
                background: #999; border-radius: 2px;
            }
            input[type=range]::-moz-range-track {
                width: 100%; height: 4px; cursor: pointer;
                background: #999; border-radius: 2px;
            }

            /* --- LEAFLET CONTROL OVERRIDES --- */
            .leaflet-control-zoom, .leaflet-control-layers {
                transform: scale(0.6); margin: 10px !important;
            }
            .leaflet-control-zoom { transform-origin: top left; }
            .leaflet-control-layers { transform-origin: top right; }
        </style>
        <title>Map Project Template</title>
    </head>
    <body>
        
        <div id="slider-container">
            <div style="margin-bottom: 6px; font-size: 9px; color: #333; letter-spacing: 0.5px; text-transform: uppercase;">
                Imagery Year: <strong><span id="yearLabel" style="color: #0078A8; font-size: 10px;">-</span></strong>
            </div>
            <input type="range" id="yearRange" step="1">
            <div class="tick-container" id="tickLabels">
                </div>
        </div>

        <div id="map"></div>
        
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.wms.js"></script>
        <script src="js/leaflet.photon.js"></script>
        
        <script src="data/NeighborhoodClusters_1.js"></script>
        <script src="data/Overview_3.js"></script>

        <script>

        // ==============================================================
        // --- 1. PROJECT CONFIGURATION (EDIT THIS SECTION ONLY) ---
        // ==============================================================
        
        const CONFIG = {
            // Map Start Position
            center: [38.900, -77.0362], // [Lat, Lng]
            zoom: 13,
            
            // Timeline Settings (Order: Oldest to Newest)
            // You can add or remove lines here, the slider will auto-adjust!
            timelineLayers: [
                { year: "2007", url: "https://maps2.dcgis.dc.gov/dcgis/services/07Ortho/MapServer/WMSServer" },
                { year: "2008", url: "https://maps2.dcgis.dc.gov/dcgis/services/08Ortho/MapServer/WMSServer" },
                { year: "2010", url: "https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2010_WebMercator/MapServer/WMSServer" },
                { year: "2013", url: "https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2013_WebMercator/MapServer/WMSServer" },
                { year: "2017", url: "https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2017_WebMercator/MapServer/WMSServer" },
                { year: "2021", url: "https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2021_WebMercator/MapServer/WMSServer" },
                { year: "2025", url: "https://maps2.dcgis.dc.gov/dcgis/services/DCGIS_DATA/Ortho2025_WebMercator/MapServer/WMSServer" }
            ]
        };

        // ==============================================================
        // --- 2. STANDARD LOGIC (DO NOT EDIT BELOW THIS LINE) ---
        // ==============================================================

        // --- MAP INIT ---
        var map = L.map('map', { zoomControl:false, attributionControl: false, maxZoom: 22, minZoom: 1 })
                   .setView(CONFIG.center, CONFIG.zoom);
        var hash = new L.Hash(map);
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);

        // --- HELPER FUNCTIONS ---
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            // (Your existing media detection logic compressed for template)
            var tempDiv = document.createElement('div'); tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media'); setTimeout(function() { popup.update(); }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video'); video.controls = true; video.src = src;
                    video.style.width = "400px"; video.style.height = "300px";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() { popup.update(); });
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                }
            }
        }

        // --- DYNAMIC LAYER GENERATION ---
        var timeLayers = [];
        var yearLabels = [];
        var wmsSettings = { layers: '0', format: 'image/png', transparent: true, uppercase: true, maxNativeZoom: 19, maxZoom: 22 };

        CONFIG.timelineLayers.forEach((item, index) => {
            var paneName = 'pane_' + item.year;
            map.createPane(paneName);
            map.getPane(paneName).style.zIndex = 400 + index; // Auto-increment z-index
            
            var layer = L.tileLayer.wms(item.url, Object.assign({pane: paneName}, wmsSettings));
            
            // Add to our arrays for the slider to use later
            timeLayers.push(layer);
            yearLabels.push(item.year);
            
            // Default to showing the last layer
            if (index === CONFIG.timelineLayers.length - 1) {
                map.addLayer(layer);
            }
        });

        // --- BUILD SLIDER UI ---
        var slider = document.getElementById("yearRange");
        var label = document.getElementById("yearLabel");
        var tickContainer = document.getElementById("tickLabels");

        // Set slider attributes dynamically
        slider.max = timeLayers.length - 1;
        slider.value = timeLayers.length - 1;

        // Generate Ticks Dynamically
        yearLabels.forEach(year => {
            var span = document.createElement("span");
            span.innerText = year;
            tickContainer.appendChild(span);
        });

        // Slider Interaction
        slider.oninput = function() {
            var index = parseInt(this.value);
            label.innerHTML = yearLabels[index];
            
            timeLayers.forEach(function(lyr) { 
                if (map.hasLayer(lyr)) map.removeLayer(lyr); 
            });
            map.addLayer(timeLayers[index]);
            
            // Bring overlays to front
            if(typeof layer_LabelsWhiteText_2 !== 'undefined' && map.hasLayer(layer_LabelsWhiteText_2)) { layer_LabelsWhiteText_2.bringToFront(); }
            if(typeof layer_Overview_3 !== 'undefined' && map.hasLayer(layer_Overview_3)) { layer_Overview_3.bringToFront(); }
            if(typeof layer_NeighborhoodClusters_1 !== 'undefined' && map.hasLayer(layer_NeighborhoodClusters_1)) { layer_NeighborhoodClusters_1.bringToFront(); }
        }
        
        // Initialize label
        label.innerHTML = yearLabels[yearLabels.length - 1];

        // ----------------------------------------------------------
        // STATIC LAYERS (Labels, Neighborhoods, etc.)
        // These usually come from your QGIS export data files.
        // ----------------------------------------------------------

        // NEIGHBORHOODS
        function pop_NeighborhoodClusters_1(feature, layer) {
            var popupContent = '<table><tr><td colspan="2">' + (feature.properties['NBH_NAMES'] !== null ? autolinker.link(String(feature.properties['NBH_NAMES']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
            layer.bindPopup(content, { maxHeight: 400 });
        }
        function style_NeighborhoodClusters_1_0() {
            return { pane: 'pane_NeighborhoodClusters_1', opacity: 1, color: 'rgba(53,121,177,1.0)', dashArray: '8.0,4.0', lineCap: 'square', lineJoin: 'bevel', weight: 2.0, fillOpacity: 0, interactive: false, }
        }
        map.createPane('pane_NeighborhoodClusters_1');
        map.getPane('pane_NeighborhoodClusters_1').style.zIndex = 407;
        var layer_NeighborhoodClusters_1 = new L.geoJson(json_NeighborhoodClusters_1, {
            attribution: '', interactive: false, dataVar: 'json_NeighborhoodClusters_1', layerName: 'layer_NeighborhoodClusters_1', pane: 'pane_NeighborhoodClusters_1', onEachFeature: pop_NeighborhoodClusters_1, style: style_NeighborhoodClusters_1_0,
        });
        map.addLayer(layer_NeighborhoodClusters_1);

        // LABELS
        map.createPane('pane_LabelsWhiteText_2');
        map.getPane('pane_LabelsWhiteText_2').style.zIndex = 408;
        var layer_LabelsWhiteText_2 = L.tileLayer('https://a.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}@2x.png', {
            pane: 'pane_LabelsWhiteText_2', opacity: 1.0, minZoom: 1, maxZoom: 22
        });
        map.addLayer(layer_LabelsWhiteText_2);
        var labelPane = map.getPane('pane_LabelsWhiteText_2');
        if (labelPane) { labelPane.style.filter = 'invert(100%) brightness(200%)'; }

        // OVERVIEW
        function pop_Overview_3(feature, layer) {
            var popupContent = '<table><tr><td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
            layer.bindPopup(content, { maxHeight: 400 });
        }
        function style_Overview_3_0() {
            return { pane: 'pane_Overview_3', opacity: 1, color: 'rgba(247,247,247,1.0)', weight: 1.0, fill: true, fillOpacity: 1, fillColor: 'rgba(82,82,82,1.0)', interactive: false, }
        }
        map.createPane('pane_Overview_3');
        map.getPane('pane_Overview_3').style.zIndex = 409;
        var layer_Overview_3 = new L.geoJson(json_Overview_3, {
            attribution: '', interactive: false, dataVar: 'json_Overview_3', layerName: 'layer_Overview_3', pane: 'pane_Overview_3', onEachFeature: pop_Overview_3, style: style_Overview_3_0,
        });
        map.addLayer(layer_Overview_3);

        // LAYER CONTROLS
        var overlaysTree = [
            {label: "Labels", layer: layer_LabelsWhiteText_2},
            {label: "Neighborhoods", layer: layer_NeighborhoodClusters_1},
        ];
        var lay = L.control.layers.tree(null, overlaysTree,{ collapsed: true });
        lay.addTo(map);

        </script>        
    </body>
</html>
